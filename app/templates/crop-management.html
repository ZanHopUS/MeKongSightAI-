<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Mùa Vụ - Mekong Sight AI</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .crop-management-container {
            max-width: 600px;
            margin: 3rem auto;
            padding: 0 1rem;
        }

        .form-section {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        .form-section h2 {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #f0fdf4;
            padding-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s;
            background-color: #f9fafb;
        }

        .form-control:focus {
            border-color: var(--primary);
            background-color: white;
            box-shadow: 0 0 0 4px var(--primary-bg);
            outline: none;
        }

        .btn-save {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .btn-back {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: var(--gray-500);
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 1.5rem;
            transition: color 0.2s;
        }

        .btn-back:hover {
            color: var(--primary);
        }
    </style>
</head>

<body style="background-color: #f3f4f6;">

    <div class="crop-management-container">

        <a href="/login" class="btn-back">
            <i class="fas fa-arrow-left"></i> Quay lại Dashboard
        </a>

        <div class="form-section">
            <h2><i class="fas fa-edit"></i> Thiết lập Mùa Vụ Mới</h2>

            <form id="crop-form">
                <div class="form-group">
                    <label class="form-label">Loại cây trồng / vật nuôi</label>
                    <div style="position: relative;">
                        <i class="fas fa-seedling"
                            style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray-400);"></i>
                        <select id="crop-type" class="form-control" style="padding-left: 2.5rem;"
                            onchange="updateVarieties()">
                            <option value="rice">Trồng Lúa</option>
                            <option value="shrimp">Nuôi Tôm</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Giống</label>
                    <div style="position: relative;">
                        <i class="fas fa-tag"
                            style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray-400);"></i>
                        <select id="crop-variety" class="form-control" style="padding-left: 2.5rem;">
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ngày xuống giống / thả nuôi</label>
                    <div style="position: relative;">
                        <i class="fas fa-calendar-alt"
                            style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray-400);"></i>
                        <input type="date" id="planting-date" class="form-control" style="padding-left: 2.5rem;">
                    </div>
                </div>

                <button type="button" class="btn-save" onclick="saveCropSettings(event)">
                    <i class="fas fa-save"></i> Lưu Thiết Lập
                </button>
            </form>
        </div>

    </div>

    <script src="/static/js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Kiểm tra đăng nhập
            const username = localStorage.getItem('mekong_username');
            if (!username) {
                alert('⚠️ Vui lòng đăng nhập trước!');
                window.location.href = '/login';
                return;
            }

            // Mặc định chọn ngày hôm nay
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('planting-date').value = today;

            // Khởi tạo danh sách giống từ script.js
            updateVarieties();
        });

        // Hàm xử lý Lưu dữ liệu
        async function saveCropSettings(event) {
            if (event) event.preventDefault();

            const username = localStorage.getItem('mekong_username');
            const cropType = document.getElementById('crop-type').value;
            const variety = document.getElementById('crop-variety').value;
            const pDate = document.getElementById('planting-date').value;

            if (!username) {
                alert("Vui lòng đăng nhập lại!");
                window.location.href = '/login';
                return;
            }

            if (!pDate) return alert("Vui lòng chọn ngày xuống giống!");

            const btn = document.querySelector('.btn-save');
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/save-crop-season', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        crop_type: cropType,
                        variety: variety,
                        planting_date: pDate
                    })
                });

                const data = await res.json();

                if (data.status === 'ok') {
                    // ✅ CHỈ HIỆN THÔNG BÁO, KHÔNG CHUYỂN TRANG
                    alert("✅ Đã lưu thành công! Bạn có thể bấm nút 'Quay lại Dashboard' ở trên.");
                } else {
                    alert("❌ Lỗi: " + (data.message || data.msg || 'Không thể lưu'));
                }
            } catch (err) {
                console.error(err);
                alert("Lỗi kết nối server");
            } finally {
                // Khôi phục nút bấm
                btn.innerHTML = oldText;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>